# Changelog

> **Purpose:** Track recent significant changes. Update after each major modification.
> Keep ~10 entries. Merge similar entries rather than adding duplicates.

## Recent Changes

| # | Date | Modification |
|---|------|--------------|
| 1 | 2026-02-19 | **Tier 1 diagnostic additions: solver convergence + constraint binding + shrinkage intensity + per-feature recon** — Implemented 4 critical diagnostic improvements per literature review plan: (1) **SCA solver convergence** — `sca_optimize()` now returns 5-tuple with `convergence_info` dict (converged flag, final_grad_norm, step_sizes, obj_improvements); `multi_start_optimize()` returns 4-tuple with `solver_stats` (n_starts, converged_count, iterations list, best_convergence_info). (2) **Constraint binding analysis** — New `get_binding_constraints()` function in constraints.py: returns n_at_w_max, n_at_w_min, n_above_w_bar, w_max_binding, tau_binding, actual_turnover, concentrated_weight, binding_fraction. (3) **Ledoit-Wolf shrinkage intensity** — `estimate_sigma_z()` now returns 3-tuple with `shrinkage_intensity` (α ∈ [0,1] for truncation method, None for spiked). (4) **Per-feature reconstruction loss** — `compute_reconstruction_loss_per_feature()` in loss.py splits MSE by feature (returns vs volatility); added to `compute_loss()` components dict and trainer history. New health checks for solver convergence and constraint binding in diagnostics.py. New report sections in diagnostic_report.py. Pipeline captures solver_stats and binding_status in state_bag. 15 new unit tests in test_diagnostic_additions.py. 11 files modified, all tests pass. |
| 2 | 2026-02-19 | **Pipeline fixes: Benchmark dropna + SP500 persistence + logging + deps** — 4 fixes from diagnostic run analysis: (1) **CRITICAL: Benchmark dropna() bug** — `pipeline.py:2489` called `.dropna(how='any')` on train_returns, removing all rows when 1205 stocks have scattered NaN on different dates → 0 rows → "Found array with 0 sample(s)" errors for MinVar/ERC/PCA benchmarks. Fix: removed `.dropna()` — each benchmark handles NaN internally. (2) **SP500 persistence** — Added auto-download with disk cache to `sp500_index.py`: `download_sp500_data()`, `load_sp500_data()`, `get_sp500_data()` with retry logic (3 attempts, exponential backoff), 1-day cache expiry. SP500 benchmark now loads from `data/sp500_index.parquet` or auto-downloads if missing. Added `data_dir` kwarg passthrough in pipeline. Created `scripts/download_sp500.py` CLI. (3) **Overfit ratio logging** — Training log now shows `best_val` and `overfit_ratio` for best epoch (was showing current epoch values). (4) **covShrinkage dependency** — Added `[shrinkage]` optional deps to pyproject.toml for DGJ analytical nonlinear shrinkage. 3 files modified, 1 file created, 511 tests pass. |
| 3 | 2026-02-19 | **sigma_z_ewma_half_life=0 justified + config coherence** — Set `sigma_z_ewma_half_life` to 0 (equal weights) as baseline, aligned with anti-cyclical strategy philosophy (strategy_philosophy.md:44-58: "crisis correlations persist permanently"). Changed config.py:451 from 126→0 and pipeline.py:289 from hardcoded `ewma_half_life=0` to use config value. Both K adaptation and Sigma_z estimation now use the same config consistently. Documentation: created `docs/sigma_z_ewma_justification.md` with full academic justification (DeMiguel 2009, Ledoit-Wolf 2004/2020, Meucci 2010). DVT §6.1 baseline = full-history estimation; EWMA is optional iteration (§6.2-6.3) triggered only when latent stability drops below 0.80. 2 files modified, 1 doc created, 497 tests pass. |
| 4 | 2026-02-19 | **Deep audit: 7 fixes across 5 files (INV-012 + VAE stability)** — Full pipeline audit addressing constraint propagation and VAE training stability: (1) **CRITICAL: constraint_params incomplete** — `pipeline.py` missing `entropy_idio_weight`, `entropy_budget_mode`, `momentum_weight`; benchmarks used hardcoded defaults instead of config, violating INV-012. Fix: added 3 keys to constraint_params dict. (2) **CRITICAL: PCA benchmark key mismatch** — `pca_factor_rp.py` used `idio_weight` but config key is `entropy_idio_weight`. Fix: corrected key name. (3) **MODERATE: raw_returns shape unvalidated** — co-movement loss computed without asserting shape match. Fix: added assertion in trainer.py. (4) **MODERATE: log_var clamping too permissive** — [-20, 20] allows std up to exp(10)≈22026. Fix: tightened to [-6, 6] per β-VAE literature (z-scored inputs → std ∈ [0.05, 20]). (5) **MODERATE: Mode F warmup checkpoint lost** — best_state=None at warmup epoch, lost if no improvement. Fix: capture state dict with copy.deepcopy(). (6) **MODERATE: Decoder padding "replicate"** — creates artificial temporal correlation at boundaries. Fix: changed to "constant" mode. 5 files modified (pipeline.py, pca_factor_rp.py, trainer.py, model.py, decoder.py), 178 tests pass, pyright 0 new errors. |
| 5 | 2026-02-19 | **Factor quality diagnostics: 6 bug fixes across 4 files** — Critical audit of initial implementation revealed alignment/propagation issues: (1) **CRITICAL: latent_stability() stock ID alignment** — function compared B_A matrices by row index, not by stock ID; when universe changes between folds (stocks enter/exit), distances were computed between different stocks. Fix: added `ids_current`/`ids_previous` parameters, aligns matrices by matching stock IDs before pdist(). (2) **CRITICAL: state_bag["latent_stability_rho"] propagation** — stability computed in walk-forward loop stored in `vae_metrics`, but `factor_quality_diagnostics()` read from `state_bag` (always None). Fix: inject from vae_metrics in `collect_diagnostics()`. (3) **MODERATE: Bai-Ng on full universe vs AU on inferred** — Bai-Ng IC2 ran on all stocks while AU was from inferred subset. Fix: filter returns to `inferred_stock_ids` before Bai-Ng. (4) **MODERATE: Onatski T dimension** — used full returns T instead of filtered T. Fix: use `T_returns` from filtered data. (5) **MINOR: N/A message for single fold** — diagnostic report now shows "N/A (single fold)" when stability unavailable. (6) **7 new unit tests** for latent_stability with stock ID alignment. 4 files modified + 7 tests, pyright 0 errors. |
| 6 | 2026-02-19 | **Factor quality diagnostics: Full implementation across 5 files** — Completed Tier 1-2 implementation from plan: (1) **factor_quality.py created** — 8 functions: `compute_persistence()` (half-life via lag-1 autocorrelation), `compute_breadth()` (normalized loadings > threshold), `compute_eigenvalue_gap()`, `compute_gap_ratio()`, `bai_ng_ic2()` (factor count IC2), `onatski_eigenvalue_ratio()` (Tracy-Widom test), `classify_factor()` (Structural/Style/Episodic), `compute_factor_quality_dashboard()`. (2) **latent_stability() activated** — existing function in metrics.py was never called; now computes Spearman ρ of inter-stock distances between B_A matrices across walk-forward folds (target ρ > 0.85). (3) **AU validation health checks** — diagnostics.py compares AU vs Bai-Ng IC2 vs Onatski with WARN/CRIT thresholds. (4) **Factor Quality Dashboard** — new section in diagnostic_report.py with AU validation, composition, per-factor table, stability. (5) **31 unit tests** — test_factor_quality.py covering all functions. 5 files modified/created, pyright 0 errors, all tests pass. |
| 7 | 2026-02-19 | **Audit entropy_idio_weight: 5 fixes across 4 files** — (1) **CRITICAL: Auto mode removed** — config allowed -1.0 but pipeline never implemented dynamic calibration; changed validation range from [-1,1] to [0,1]. (2) **CRITICAL: PCA benchmark idio_weight** — pca_factor_rp.py didn't pass idio_weight to frontier (always used default 0.2); now passes from constraint_params for fair comparison. (3) **d_eps_floor enforcement** — variance targeting could violate floor; added np.maximum guard at both VT code paths. (4) **Shape assertions** — added len(D_eps)==len(w) validation in entropy.py for both compute functions. (5) **Integration test** — new test for cardinality + D_eps slicing. 4 files modified + 1 test added, pyright 0 errors. |
| 8 | 2026-02-19 | **Idiosyncratic risk: Literature review + entropy reactivation** — Created `docs/literature_review_idiosyncratic_risk.md` synthesizing academic research on idiosyncratic risk (Goyal 2001: 90% of total risk), optimal cardinality (DeMiguel 2009: 3000+ months needed), and Roncalli factor+idio risk budgeting. Reactivated two-layer entropy by setting `entropy_idio_weight=0.20` (was 0.0 since Phase 14). Empirical justification: ~15-20% idio contribution in diversified portfolios matches FF3 R²>90%. The two-layer formulation was already implemented in entropy.py but disabled — no new code needed. 1 doc + 1 config line changed. |
| 9 | 2026-02-18 | **Strategy analysis: Factor quality + cardinality + MDP implementation** — Implemented Tier 1-2 recommendations from literature review: (1) **Factor quality module** (`src/risk_model/factor_quality.py`) with persistence (half-life), scope (breadth), stability metrics, Bai-Ng IC2 and Onatski eigenvalue tests for AU validation. (2) **Literature documentation** (`docs/literature_review_strategy.md`) synthesizing downside risk debate (Ang 2006 vs Atilgan 2020), cardinality research (DeMiguel 2009, JRFM 2021), MDP (Choueifaty 2008), factor characterization (Lettau & Pelger 2020, Onatski 2010). Addresses 3 fundamental questions: symmetric vs downside risk, stock count for diversification, factor dimensions beyond eigenvalue. 2 new files, pyright 0 errors. |
| 10 | 2026-02-17 | **CRITICAL: K adaptation EWMA leak fix** — `_adapt_vae_params()` passed `ewma_half_life=126` to `compute_au_max_stat()`, crushing N_eff from 6300→363 and capping K at 38 instead of 150. The EWMA weighting is for downstream Sigma_z covariance estimation, not for VAE capacity sizing (the encoder sees all windows with equal weight). Fix: `ewma_half_life=0` in K adaptation; post-inference AU truncation (line ~1719) correctly keeps EWMA. Effect: K 38→150, AU_max_stat 19→79, enabling the VAE to discover more latent structure. 1 file modified (pipeline.py), pyright 0 errors. |


---

## Current State

- **Status**: Development — All 4 phases + tests + dashboard + performance optimizations + TensorBoard + diagnostic pipeline + **factor quality diagnostics** complete. 49 source files + 14 test files + 1 notebook. SP500 priority download + penny stock/min history filters active.
- **Main features**: Full data pipeline, 1D-CNN VAE, 3-mode loss with co-movement curriculum, training loop with AMP + TensorBoard + curriculum batching + CUDA T4 optimizations (TF32, fused AdamW, gradient accumulation/checkpointing), inference + AU with AMP autocast, dual-rescaled factor risk model, portfolio optimization (SCA+Armijo, parametric CVXPY, Cholesky, parallel multi-starts, 4-strategy cardinality enforcement with MIQP pre-screening + two-stage decomposition), early training checkpoint, 6 benchmarks, walk-forward (34 folds) + direct training mode, statistical tests, reporting, **E2E diagnostic pipeline** (health checks, MD/JSON/CSV/PNG reports, quick/full profiles, **factor quality dashboard** with AU validation via Bai-Ng IC2 + Onatski + latent stability tracking), 3 CLI entry points, dashboard notebook, SP500-first download with data quality filters
- **Next**: Full Tiingo SP500 diagnostic re-run to verify all recent fixes (K adaptation, Phase 14-15 corrections, entropy_idio_weight=0.20, factor quality diagnostics).

---

## Update Protocol

After each significant modification:

1. Add new entry at position 1, shift others down
2. If similar entry exists, update it instead of adding
3. If > 10 entries, remove entry #10
4. Update "Current State" if project status changed
