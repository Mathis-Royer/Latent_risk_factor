# Changelog

> **Purpose:** Track recent significant changes. Update after each major modification.
> Keep ~10 entries. Merge similar entries rather than adding duplicates.

## Recent Changes

| # | Date | Modification |
|---|------|--------------|
| 10 | 2026-02-16 | **Phase 9 audit: 5 fixes across 5 files** (post-VAE portfolio + benchmarks): (1) **CRITICAL: Adaptive ENB target** (Meucci 2009, Roncalli 2013 Ch. 7) — replaced naive `n_signal/2` target with `min(n_signal/2, ENB_spectrum * 0.7)` where `ENB_spectrum = exp(H(eigenvalue_spectrum))` is the maximum achievable ENB for the current eigenvalue structure. With lambda_1/lambda_2=9.99, old target 6.0 was unreachable (max ENB≈2.6), forcing alpha_opt=0.001 (quasi min-variance). New target adapts to spectral concentration. (2) **BUG: Fallback argmax(enb_mono)** — `select_operating_alpha` fallback used raw `enb` instead of `enb_mono` (monotone envelope), causing incorrect alpha selection on non-monotonic frontiers from SCA local optima. (3) **INV-012: constraint_params complete** — added missing `w_bar` and `alpha_grid` to benchmark constraint_params dict (DeMiguel et al. 2009). (4) **INV-012: effective_cap = min(w_bar, w_max)** in base.py `_project_to_constraints()` and min_variance.py CVXPY constraints, matching VAE hard cap (Jagannathan & Ma 2003). (5) **DOC: ERC near-uniform warning** — log warning when ERC risk contributions max/min < 1.5, documenting that ERC≈EW is expected under LW shrinkage on large universes (Maillard et al. 2010, Prop. 3). Also: non-trivial selection health check + checkpoint passthrough in run_diagnostic.py. 5+2 files modified, pyright 0 errors, 440 unit tests pass. |
| 10 | 2026-02-16 | **Deep audit phase 8: 7 literature-backed fixes across 5 files** (post-VAE portfolio pipeline): (1) **CRITIQUE: w_bar 0.01→0.03** — quasi-EW portfolio (102 positions, Gini=0.019) caused by hard cap min(w_bar,w_max)=0.01. Realigned to config default 0.03, enabling 33-50 position tilts (Brodie et al. 2009 PNAS, Ao et al. 2019 RFS). (2) **CRITIQUE: Market PC1 excluded from entropy** (Meucci 2009) — when market_intercept=True, eigenvalues_signal starts at index 1 (skip market factor). ENB target uses n_signal_eff (without market). Market is non-diversifiable; including it capped ENB at 2.81. (3) **IMPORTANT: B_A_SHRINKAGE_ALPHA 0.15→0.0** — uniform scaling is not James-Stein shrinkage (Ledoit-Wolf 2003/2020, Fan-Liao-Mincheva 2013 POET, Barra USE4); absorbed by VT. (4) **IMPORTANT: PCA benchmark frontier** — replaced hardcoded alpha=0.1 with full variance-entropy frontier + select_operating_alpha (INV-012 parity). w_bar from constraint_params. Turnover projection added. (5) **IMPORTANT: ERC NaN handling** — dropna() emptied DataFrame for 600+ stocks; replaced with >50% NaN stock filter + fillna(0). (6) **MODERE: var_ratio fillna(0)@w** — portfolio return computed directly via R.fillna(0)@w instead of dropna("any") which eliminated most OOS days. (7) **MODERE: PHI 20→0.0** — soft concentration penalty redundant with hard cap w_bar. Also: EWMA Sigma_z uses z_input.T@z_input (not np.cov which double-divides by n). 5 files modified (pipeline.py, pca_factor_rp.py, erc.py, covariance.py, dashboard.ipynb), pyright 0 errors, 440 unit tests pass. |
| 10 | 2026-02-15 | **Deep audit phase 7: 5 fixes across 5 files** (critical review followup): (1) **CRITICAL: w_old alignment by stock ID** — turnover measurement and SCA turnover constraints now use stock-ID mapping instead of positional alignment between folds. New `_align_weights_by_stock_id()` helper; `_run_single_fold` returns `inferred_stock_ids` for ID tracking. Fixes incorrect turnover and wrong-stock penalization when universe changes between folds. (2) **IMPORTANT: Bayesian VT shrinkage** (Barra USE4, Menchero et al. 2011 §4) — replaced raw `clip(vt, 0.01, 100)` with Bayesian shrinkage `vt_shrunk=(n·vt_raw+ν·1.0)/(n+ν)` where ν=60, then clip to [0.1, 10.0]. Applied to all 4 VT paths (per-factor, idiosyncratic, block-level, scalar fallback). Prevents extreme VT amplification from short holdouts. (3) **MODERATE: entropy_idio_weight 0.2→0.05** — reduces defensive bias from idiosyncratic entropy layer that conflicted with momentum signal (H_idio gradient favors low-D_eps stocks). 5% preserves guard-rail without dominating. (4) **MODERATE: lstsq rank diagnostic** — `safe_solve()` and `safe_solve_wls()` now log warnings when effective rank < p, with condition number. Zero behavioral change; provides traceability for ill-conditioned cross-sections. (5) **MINOR: Diversified frontier seeds** — `seed+idx` instead of fixed `seed` for Dirichlet starts across alpha grid. 5 files modified (pipeline.py, config.py, conditioning.py, frontier.py), pyright 0 errors, 77 unit tests pass. |
| 10 | 2026-02-15 | **Deep audit phase 6: 5 fixes across 5 files** (post-VAE portfolio pipeline critical review): (1) **CRITICAL: ENB target on H_factor only** (Meucci 2009, Roncalli 2013 Ch. 7) — `select_operating_alpha` now uses `entropy_factor` (factor-only H) for ENB target instead of combined two-layer H. The idiosyncratic layer (n>>AU terms) trivially inflated ENB, collapsing portfolio to near min-variance (ENB_factor needed only 1.3/5 to satisfy target). Frontier now records `entropy_factor` column alongside `entropy`. `H_norm_signal` uses `H_factor/ln(n_signal)` (stays in [0,1]). (2) **IMPORTANT: DGJ/EWMA decoupled** — signal detection (`n_signal`) now uses RAW covariance (gamma=p/n_raw, lower BBP threshold) while Sigma_z uses EWMA covariance (gamma=p/n_eff for correct magnitudes). Prevents EWMA n_eff from inflating gamma ~5x and misclassifying secondary signal factors as noise. (3) **IMPORTANT: Per-factor VT** (Barra USE4, Menchero et al. 2011 §4) — replaced EW portfolio-based block VT with per-factor calibration: `vt_k = Var(z_holdout_k)/eigenvalue_k` in principal basis + `vt_idio = median(realized_idio/D_eps)` from holdout residuals. Eliminates dependency on EW portfolio (beta_eq≈0 after z-scoring). (4) **MODERATE: INV-012 turnover symmetry** — `_run_single_fold` now receives `w_old`/`is_first` from walk-forward loop, matching benchmark treatment. Turnover constraints active for VAE from fold 2+. (5) **MINOR: w_max/w_bar doc** — documented that `min(w_bar, w_max)` dominates; w_max=0.05 inactive when w_bar=0.03. 5 files modified (frontier.py, covariance.py, pipeline.py, metrics.py, config.py), pyright 0 errors, 198 unit + 22 integration tests pass. |
| 10 | 2026-02-15 | **Deep audit phase 5: 7 fixes across 3 files**: (1) **Full Sigma_assets for risk** (DGJ 2018 Th. 2.2) — noise eigenvalues kept at sigma_sq in Sigma_assets (risk term), only signal eigenvalues used for entropy; prevents systematic risk underestimation from zeroing DGJ bulk. (2) **Frontier returns weights** — `compute_variance_entropy_frontier` returns `dict[float, ndarray]`; pipeline reuses frontier weights instead of redundant `multi_start_optimize` (saves ~30s/fold). (3) **Turnover tracking + net Sharpe** (DeMiguel et al. 2009, Novy-Marx & Velikov 2016) — inter-fold `w_old` tracking, `turnover`, `transaction_cost`, `sharpe_net` metrics; `transaction_cost_bps=10` config. (4) **VT coverage filter** — replaced `fillna(0.0)` with 90% coverage threshold + cross-sectional mean fill; prevents downward variance bias from delisted stocks. (5) **ENB monotone envelope** — `np.maximum.accumulate(enb)` in `select_operating_alpha`; handles non-monotonic frontiers from SCA local optima. (6) **Alpha=0 guard** — grid starts at 0.001 (not 0); pipeline forces `alpha_opt > 0` to ensure entropy contributes. (7) **Fixed idio_weight=0.2** — removed EW auto-calibration (circular dependency); `entropy_idio_weight` default -1.0→0.2. 3 files modified (pipeline.py, frontier.py, config.py), pyright 0 errors, 77 unit + 7 integration tests pass. |
| 10 | 2026-02-15 | **Deep audit phase 4: 7 literature-backed improvements across 8 files**: (1) **WLS iterative regression** (Fama-MacBeth 1973, Barra USE4) — 2-pass WLS in `factor_regression.py`: OLS→residuals→per-stock σ²_eps→WLS with weights=1/σ²_eps. New `safe_solve_wls()` in conditioning.py. Config: `use_wls=True`. (2) **Disjoint VT holdout** (Shephard & Sheppard 2010) — split z_hat into estimation (80%) and holdout (20%); Sigma_z/D_eps estimated from estimation period only; VT calibrated on holdout via date-keyed alignment. (3) **Hard concentration constraint** (Jagannathan & Ma 2003) — replaced soft penalty φ·P_conc with hard `w_i ≤ min(w_bar, w_max)` in CVXPY; φ default 5.0→0.0; simplifies objective to variance+entropy+turnover only. Threaded through sca_solver.py, cardinality.py (MIQP+two-stage). (4) **D_eps kurtosis correction** (DasGupta 2008) — `Var(d̂_i)=d²·(κ₄+2)/(T-1)` replaces Gaussian `2d²/(T-1)`, using per-stock empirical excess kurtosis via `scipy.stats.kurtosis`. (5) **AU_max_stat with n_eff** (Kish 1965) — uses EWMA effective sample size instead of raw n_obs; new `compute_ewma_n_eff()`. (6) **Parametric CVXPY** — `_SCASubproblemBuilder` uses `cp.Parameter(n)` for entropy gradient; problem built once, only parameter updated per iteration. (7) **Dynamic idiosyncratic entropy weight** (Meucci 2009, Roncalli 2013) — auto-calibrated `idio_weight = idio_risk/(sys_risk+idio_risk)` from EW portfolio; sentinel `entropy_idio_weight=-1.0`. 8 files modified, pyright 0 errors, 77 unit tests pass. |
| 10 | 2026-02-15 | **Deep audit phase 3: 5 fixes across 6 files**: (1) **Factor regression lstsq** — replaced manual `(B^T B)^{-1} B^T r` + negligible ridge (λ=1e-6) with `np.linalg.lstsq()` for SVD-based ill-conditioning handling (conditioning.py). (2) **D_eps James-Stein formula corrected** — old formula `(p+2)/(n·Σ(d/d̄-1)²)` is Stein's shrinkage for normal means; replaced with proper variance shrinkage `Σ Var(d̂_i) / Σ(d̂_i-d̄)²` where `Var(d̂_i) = 2d̂_i²/(T_i-1)` per Ledoit-Wolf 2004 §3.4 (covariance.py). (3) **B_A normalization ddof** — `ddof=0`→`ddof=1` for unbiased sample std in z-score normalization (pipeline.py). (4) **H_norm_signal metric** — new `n_signal` parameter in `portfolio_metrics()`, computes `H/ln(n_signal)` instead of `H/ln(K)` or `H/ln(AU)` (metrics.py, pipeline.py). (5) **Sigma_assets symmetrization** — explicit `0.5*(Σ+Σ^T)` after eigenvalue truncation and VT reconstruction (pipeline.py, 2 locations). Also: Armijo line search uses directional derivative instead of clamped surrogate improvement; VT fallback weights properly normalized; O(n²) date lookup replaced with O(1) dict. 7 files modified, pyright 0 errors, 118 unit + 22 integration tests pass. |
| 10 | 2026-02-15 | **Deep audit phase 2: 8 fixes across 10 files**: (1) **CRITICAL: Two-layer entropy** — idiosyncratic contributions (n=611) drowned out factor entropy signal (AU=52). New formulation: `H = (1-w_idio)*H_factor + w_idio*H_idio` with separate layers (Roncalli 2013/Meucci 2009). New `entropy_idio_weight` config param (default 0.2). Threaded through entropy.py, sca_solver.py, frontier.py, cardinality.py, pipeline.py. (2) **CRITICAL: B_A shrinkage removed** — was pure scaling (×0.85), not true James-Stein; `b_a_shrinkage_alpha` 0.15→0.0. (3) **CRITICAL: ERC budget_scale fix** — Spinu log-barrier `c=n` → `c=1`; barrier was overwhelming risk term for n=611, making ERC identical to EW. Added solver status logging + risk contribution diagnostic. (4) **Eigenvalue power** 0.65→0.50 for more aggressive spectrum compression (target n_eff~10). (5) **Block-level VT** — replaced scalar `_scalar_variance_targeting` with `_block_variance_targeting`: separate `vt_sys`/`vt_idio` scales via minimal-distance OLS (Barra USE4). (6) **Var ratio diagnostic** — `dropna("any")` → `fillna(0)` with coverage reporting; NaN when coverage <50%. (7) **EWMA half-life** 0→252 for time-varying factor covariance. (8) **Projection passes** 3→10. 10 files modified, pyright 0 errors, 178 unit tests pass. |
| 10 | 2026-02-15 | **Deep audit phase 1: post-VAE portfolio pipeline — 7 fixes across 5 files**: (1) **CRITICAL: Objective scale mismatch** — `lambda_risk` 1.0→252.0 (annualize daily variance); risk term was 700x smaller than entropy/concentration, optimizer ignored variance minimization. (2) **Alpha grid coarseness** — expanded from 6 to 12 log-uniform points for reliable Kneedle elbow detection. (3) **n_starts** 3→5 to include 2 random Dirichlet starts. (4) **w_bar validation** — added warning when `w_bar < 2*w_min` (self-defeating concentration penalty). (5) **SCA Armijo fix** — replaced `max(delta_surr, tol)` with `max(delta_surr, 0.0)` for cleaner handling when surrogate doesn't improve. (6) **Post-SCA projection** — 3-pass clip-renormalize loop to prevent w_max violation. (7) **H_norm_eff metric** — effective dimensionality `n_eff=exp(H_eigenvalue)` gives meaningful entropy normalization vs AU. (8) **D_eps James-Stein shrinkage** — stabilizes per-stock idiosyncratic variance (Ledoit-Wolf 2004 §3.4). 6 files modified, pyright 0 errors, 73 targeted tests pass. |
| 10 | 2026-02-15 | **Risk model calibration + momentum bug fix — 4 changes**: (1) **CRITICAL: Momentum lost in cardinality enforcement** — `mu` was missing from `sca_kwargs` passed to `enforce_cardinality()`, so the re-optimization during position elimination ran without the momentum signal, negating the alpha tilt. Fix: added `"mu": mu` to sca_kwargs. (2) **B_A scale normalization** — VAE encoder output has unconstrained scale (mean \|B_A\|=0.10), causing 4-7x covariance overestimation. New `b_a_normalize=True` rescales B_A so mean(\|B_A\|)=1/sqrt(AU) before shrinkage. (3) **Risk model defaults updated** — `sigma_z_eigenvalue_pct` 1.0→0.95 (truncate noisy dimensions), `eigenvalue_power` 1.0→0.65 (compress dominant eigenvalues, top-3 from 59%→~45%), `b_a_shrinkage_alpha` 0.0→0.15 (reduce spurious cross-stock correlations). (4) Config docstring updated. 2 files modified (pipeline.py, config.py), pyright 0 errors. |
| 9 | 2026-02-14 | **Comprehensive diagnostic metrics audit — 7 fixes**: (1) **CRITICAL: Benchmark return/Sharpe aligned to geometric** — benchmarks used arithmetic `mean(r)*252`, now use geometric `prod(1+r)^(252/n)-1` matching VAE (eliminates systematic Jensen's inequality bias ~1.3% ann. favoring benchmarks). (2) **CRITICAL: Dual VT non-degenerate** — old proportional allocation gave identical sys/idio scales (algebraically `realized/pred_total` for both); new implementation decomposes realized returns via cross-sectional OLS into systematic and idiosyncratic components, calibrating each block independently (Barra USE4 methodology). (3) **MDD in percentage** — converted from log-space to `1-exp(min_drawdown)` (old: MDD=30% reported 30 log-pts, actual 25.9%). (4) **Var ratio NaN bias** — replaced `fillna(0.0)` with `dropna(how="any")` to avoid downward variance bias. (5) **Convergence NaN guard** — filter NaN before `linregress` in last-10-epoch check. (6) **KL top-3 fraction** — added `kl_top3_fraction` diagnostic (more informative than `kl_concentration` which is always ~1.0). (7) **Overfit thresholds aligned** — trainer flag now triggers at 1.3 (was 1.5) matching diagnostics warning threshold. 6 files modified (base.py, metrics.py, pipeline.py, diagnostics.py, trainer.py, test_divergences.py), pyright 0 errors, 436 tests pass. |
| 9 | 2026-02-11 | **Structural covariance overestimation fixes (vt_scale=0.1)**: Two new levers to reduce B·Σ_z·B^T overestimation. (1) **Exponential decay aggregation** in `aggregate_profiles()` — new `half_life` parameter gives more weight to recent windows so B_A reflects current factor structure, not the static average over all history. (2) **Eigenvalue truncation** in `estimate_sigma_z()` — new `eigenvalue_pct` parameter keeps only top-k eigenvalues explaining X% of Σ_z variance, zeros out noisy factor dimensions. Config: `InferenceConfig.aggregation_half_life` (default 0=legacy, 60 recommended) and `RiskModelConfig.sigma_z_eigenvalue_pct` (default 1.0=legacy, 0.95 recommended). Notebook Section 2b updated with `AGGREGATION_HALF_LIFE=60` and `SIGMA_Z_EIGENVALUE_PCT=0.95`. 4 files modified (composite.py, covariance.py, config.py, pipeline.py), pyright 0 errors, 429 tests pass. |
| 8 | 2026-02-10 | **E2E diagnostic pipeline**: Created `diagnostics.py`, `diagnostic_report.py`, `diagnostic_plots.py`, `run_diagnostic.py`. Health checks, MD/JSON/CSV/PNG reports, quick/full profiles. |


---

## Current State

- **Status**: Development — All 4 phases + tests + dashboard + performance optimizations + TensorBoard + diagnostic pipeline complete. 48 source files + 13 test files + 1 notebook. SP500 priority download + penny stock/min history filters active.
- **Main features**: Full data pipeline, 1D-CNN VAE, 3-mode loss with co-movement curriculum, training loop with AMP + TensorBoard + curriculum batching + CUDA T4 optimizations (TF32, fused AdamW, gradient accumulation/checkpointing), inference + AU with AMP autocast, dual-rescaled factor risk model, portfolio optimization (SCA+Armijo, parametric CVXPY, Cholesky, parallel multi-starts, 4-strategy cardinality enforcement with MIQP pre-screening + two-stage decomposition), early training checkpoint, 6 benchmarks, walk-forward (34 folds) + direct training mode, statistical tests, reporting, **E2E diagnostic pipeline** (health checks, MD/JSON/CSV/PNG reports, quick/full profiles), 3 CLI entry points, dashboard notebook, SP500-first download with data quality filters
- **Next**: End-to-end diagnostic run on Tiingo SP500 data

---

## Update Protocol

After each significant modification:

1. Add new entry at position 1, shift others down
2. If similar entry exists, update it instead of adding
3. If > 10 entries, remove entry #10
4. Update "Current State" if project status changed
